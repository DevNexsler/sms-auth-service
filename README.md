# RCS Authentication Service

A security-first authentication service using RCS (Rich Communication Services) for enhanced messaging security. This service implements email-based authentication with RCS notifications, providing protection against SMS vulnerabilities while maintaining a seamless user experience.

## Architecture Overview

- **Express.js** server handling authentication endpoints
- **Supabase Auth** for user management and authentication
- **Twilio** for SMS messaging
- **PostgreSQL** (via Supabase) for session storage
- **Docker** containerization for deployment
- **Render.com** hosting platform

## Features

- üîê **RCS-First Security** - Enforces RCS for authenticated sessions
- ‚úâÔ∏è **Email Primary Auth** - Magic links sent via email for security
- üì± **RCS Notifications** - Rich, encrypted messaging for session updates
- üõ°Ô∏è **Channel Protection** - Detects and blocks RCS ‚Üí SMS downgrades
- ‚è±Ô∏è **Configurable Sessions** - 1, 3, 5, or 30-day session durations
- üö´ **No SMS Fallback** - Maintains security by requiring RCS
- üìä **Channel Tracking** - Monitors message delivery channels
- üîÑ **Rate Limiting** - 3 attempts per hour per phone number

## Prerequisites

- Node.js 16+ (locally for development)
- Supabase project with Auth enabled
- Twilio account with:
  - RCS Beta Access (apply at Twilio Console)
  - Messaging Service with RCS Sender configured
  - Verified business profile for RCS
- GitHub account (for Render deployment)
- Render account

### RCS Requirements

1. **Apply for RCS Beta Access**
   - Fill out the [RCS request form](https://www.twilio.com/console/sms/rcs)
   - Approval typically takes 1-3 weeks

2. **Create RCS Sender**
   - Brand name and logo
   - Business verification
   - Compliance documentation

3. **Device Requirements**
   - Android with Google Messages (Chat features enabled)
   - iOS 18+ with RCS enabled
   - Active mobile data or WiFi connection

## Local Development

1. **Clone the repository**
   ```bash
   git clone <your-repo-url>
   cd sms-auth-service
   ```

2. **Install dependencies**
   ```bash
   npm install
   ```

3. **Configure environment variables**
   ```bash
   cp .env.example .env
   # Edit .env with your actual values
   ```

4. **Run the development server**
   ```bash
   npm run dev
   ```

## Deployment to Render

### Step 1: Prepare the Service

1. **Push to GitHub**
   ```bash
   git add .
   git commit -m "Initial SMS authentication service"
   git push origin main
   ```

2. **Ensure all files are present**
   - `Dockerfile`
   - `render.yaml`
   - `package.json` and `package-lock.json`
   - `src/` directory with all handlers

### Step 2: Create Render Service

1. **Log in to Render Dashboard**
   - Go to https://dashboard.render.com

2. **Create New Web Service**
   - Click "New +" ‚Üí "Web Service"
   - Connect your GitHub repository
   - Select the repository containing this service

3. **Configure Service Settings**
   - **Name**: `sms-auth-service`
   - **Region**: Oregon (or your preferred region)
   - **Branch**: main
   - **Runtime**: Docker
   - **Plan**: Starter ($7/month)

### Step 3: Configure Environment Variables

In the Render dashboard, add these environment variables:

```bash
# Supabase Configuration (from your .env file)
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# Twilio Configuration
TWILIO_ACCOUNT_SID=your-account-sid
TWILIO_AUTH_TOKEN=your-auth-token
TWILIO_PHONE_NUMBER=+1234567890

# RCS Configuration (REQUIRED)
MESSAGING_SERVICE_SID=your-messaging-service-sid
RCS_SENDER_ID=your-rcs-sender-id  # Optional until RCS approved

# These are set automatically by render.yaml:
# NODE_ENV=production
# PORT=<auto-generated>
# APP_URL=https://rcs-auth-service.onrender.com
# SESSION_DURATION_DAYS=7
# RCS_SECURITY_REQUIRED=true
# ALLOW_SMS_INITIAL_CONTACT=true
# RCS_SETUP_URL=https://rcs-auth-service.onrender.com/rcs-setup
```

### Step 4: Deploy

1. Click "Create Web Service"
2. Wait for the initial deployment to complete
3. Note your service URL: `https://rcs-auth-service.onrender.com`

### Step 5: Configure External Services

1. **Update Supabase Redirect URLs**
   - Go to Supabase Dashboard ‚Üí Authentication ‚Üí URL Configuration
   - Add to Redirect URLs:
     ```
     https://rcs-auth-service.onrender.com/api/auth/callback
     ```

2. **Configure Twilio Messaging Service**
   - Go to Twilio Console ‚Üí Messaging ‚Üí Services ‚Üí Your Service
   - Add webhook URLs:
     - Incoming Messages: `https://rcs-auth-service.onrender.com/api/twilio/webhook`
     - Status Callback: `https://rcs-auth-service.onrender.com/api/twilio/status-callback`
   - Method: HTTP POST for both

3. **Enable RCS Sender**
   - In your Messaging Service, add your approved RCS Sender
   - Configure sender pool with RCS as primary

### Step 6: Test the Deployment

1. **Check Health Endpoint**
   ```bash
   curl https://rcs-auth-service.onrender.com/health
   ```

2. **Verify RCS Setup**
   - Visit: `https://rcs-auth-service.onrender.com/rcs-setup`
   - Follow instructions to enable RCS on your device

3. **Test RCS Authentication**
   - Ensure RCS is enabled on your device
   - Send message: `LOGIN` to your Twilio number
   - Check email for magic link
   - Monitor RCS channel in session

4. **Test Security Downgrade**
   - Disable mobile data/WiFi to force SMS
   - Send a message - should receive security warning

## API Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/health` | GET | Health check endpoint |
| `/api/twilio/webhook` | POST | Twilio RCS/SMS webhook |
| `/api/twilio/status-callback` | POST | Channel detection callback |
| `/api/auth/callback` | GET | Supabase auth callback |
| `/api/auth/status` | GET | Check session status |
| `/rcs-setup` | GET | RCS setup instructions |

## Environment Variables

| Variable | Description | Required | Default |
|----------|-------------|----------|---------|
| `SUPABASE_URL` | Your Supabase project URL | Yes | - |
| `SUPABASE_ANON_KEY` | Supabase anonymous key | Yes | - |
| `SUPABASE_SERVICE_ROLE_KEY` | Supabase service role key | Yes | - |
| `TWILIO_ACCOUNT_SID` | Twilio account SID | Yes | - |
| `TWILIO_AUTH_TOKEN` | Twilio auth token | Yes | - |
| `TWILIO_PHONE_NUMBER` | Your Twilio phone number | Yes | - |
| `MESSAGING_SERVICE_SID` | Twilio Messaging Service SID | Yes | - |
| `RCS_SENDER_ID` | RCS Sender ID (after approval) | No | - |
| `SESSION_DURATION_DAYS` | Session duration in days | No | 7 |
| `RCS_SECURITY_REQUIRED` | Enforce RCS for sessions | No | true |
| `ALLOW_SMS_INITIAL_CONTACT` | Allow first LOGIN via SMS | No | true |
| `RCS_SETUP_URL` | URL for RCS setup instructions | No | /rcs-setup |

## Monitoring and Logs

- View logs in Render Dashboard ‚Üí Your Service ‚Üí Logs
- Monitor health checks and request metrics
- Set up alerts for service downtime

## Security Considerations

- All environment variables are encrypted in Render
- Service role key is only used server-side
- Rate limiting prevents abuse
- Sessions expire after configured duration
- HTTPS enforced for all endpoints

## Troubleshooting

### Service won't start
- Check environment variables are set correctly
- Verify Dockerfile syntax
- Review deployment logs in Render

### SMS not received
- Verify Twilio webhook URL is correct
- Check Twilio phone number is active
- Review Twilio logs for errors

### Authentication fails
- Ensure Supabase redirect URLs include your service URL
- Verify email is correct format
- Check session hasn't expired

### Database errors
- Confirm sms_sessions table exists in Supabase
- Check RLS policies are correctly set
- Verify service role key has proper permissions

## Support

For issues or questions:
1. Check Render deployment logs
2. Review Supabase Auth logs
3. Check Twilio console for SMS delivery status
4. Open an issue in the repository

## License

MIT