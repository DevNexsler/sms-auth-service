# SMS Authentication Service

A standalone microservice for SMS-based authentication using Supabase Auth and Twilio. This service enables users to authenticate via SMS with cross-channel verification through email magic links or OTP codes.

## Architecture Overview

- **Express.js** server handling authentication endpoints
- **Supabase Auth** for user management and authentication
- **Twilio** for SMS messaging
- **PostgreSQL** (via Supabase) for session storage
- **Docker** containerization for deployment
- **Render.com** hosting platform

## Features

- ✅ SMS authentication with phone number verification
- ✅ Cross-channel verification (SMS → Email)
- ✅ Magic link authentication (default)
- ✅ OTP code authentication (optional)
- ✅ Rate limiting (3 attempts per hour)
- ✅ Session management with expiration
- ✅ Integration with existing RBAC system

## Prerequisites

- Node.js 16+ (locally for development)
- Supabase project with Auth enabled
- Twilio account with SMS-capable phone number
- GitHub account (for Render deployment)
- Render account

## Local Development

1. **Clone the repository**
   ```bash
   git clone <your-repo-url>
   cd sms-auth-service
   ```

2. **Install dependencies**
   ```bash
   npm install
   ```

3. **Configure environment variables**
   ```bash
   cp .env.example .env
   # Edit .env with your actual values
   ```

4. **Run the development server**
   ```bash
   npm run dev
   ```

## Deployment to Render

### Step 1: Prepare the Service

1. **Push to GitHub**
   ```bash
   git add .
   git commit -m "Initial SMS authentication service"
   git push origin main
   ```

2. **Ensure all files are present**
   - `Dockerfile`
   - `render.yaml`
   - `package.json` and `package-lock.json`
   - `src/` directory with all handlers

### Step 2: Create Render Service

1. **Log in to Render Dashboard**
   - Go to https://dashboard.render.com

2. **Create New Web Service**
   - Click "New +" → "Web Service"
   - Connect your GitHub repository
   - Select the repository containing this service

3. **Configure Service Settings**
   - **Name**: `sms-auth-service`
   - **Region**: Oregon (or your preferred region)
   - **Branch**: main
   - **Runtime**: Docker
   - **Plan**: Starter ($7/month)

### Step 3: Configure Environment Variables

In the Render dashboard, add these environment variables:

```bash
# Supabase Configuration (from your .env file)
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# Twilio Configuration
TWILIO_ACCOUNT_SID=your-account-sid
TWILIO_AUTH_TOKEN=your-auth-token
TWILIO_PHONE_NUMBER=+1234567890

# These are set automatically by render.yaml:
# NODE_ENV=production
# PORT=<auto-generated>
# APP_URL=https://sms-auth-service.onrender.com
# AUTH_SESSION_DURATION_DAYS=7
# AUTH_METHOD=magic_link
```

### Step 4: Deploy

1. Click "Create Web Service"
2. Wait for the initial deployment to complete
3. Note your service URL: `https://sms-auth-service.onrender.com`

### Step 5: Configure External Services

1. **Update Supabase Redirect URLs**
   - Go to Supabase Dashboard → Authentication → URL Configuration
   - Add to Redirect URLs:
     ```
     https://sms-auth-service.onrender.com/api/auth/callback
     ```

2. **Configure Twilio Webhook**
   - Go to Twilio Console → Phone Numbers → Your Number
   - Set the webhook URL for incoming SMS:
     ```
     https://sms-auth-service.onrender.com/api/twilio/webhook
     ```
   - Method: HTTP POST

### Step 6: Test the Deployment

1. **Check Health Endpoint**
   ```bash
   curl https://sms-auth-service.onrender.com/health
   ```

2. **Test SMS Authentication**
   - Send an SMS with format: `LOGIN your-email@example.com`
   - Check email for magic link
   - Click link to authenticate

## API Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/health` | GET | Health check endpoint |
| `/api/twilio/webhook` | POST | Twilio SMS webhook |
| `/api/auth/callback` | GET | Supabase auth callback |
| `/api/auth/status` | GET | Check session status |

## Environment Variables

| Variable | Description | Required |
|----------|-------------|----------|
| `SUPABASE_URL` | Your Supabase project URL | Yes |
| `SUPABASE_ANON_KEY` | Supabase anonymous key | Yes |
| `SUPABASE_SERVICE_ROLE_KEY` | Supabase service role key | Yes |
| `TWILIO_ACCOUNT_SID` | Twilio account SID | Yes |
| `TWILIO_AUTH_TOKEN` | Twilio auth token | Yes |
| `TWILIO_PHONE_NUMBER` | Your Twilio phone number | Yes |
| `AUTH_SESSION_DURATION_DAYS` | Session duration in days | No (default: 7) |
| `AUTH_METHOD` | Authentication method | No (default: magic_link) |

## Monitoring and Logs

- View logs in Render Dashboard → Your Service → Logs
- Monitor health checks and request metrics
- Set up alerts for service downtime

## Security Considerations

- All environment variables are encrypted in Render
- Service role key is only used server-side
- Rate limiting prevents abuse
- Sessions expire after configured duration
- HTTPS enforced for all endpoints

## Troubleshooting

### Service won't start
- Check environment variables are set correctly
- Verify Dockerfile syntax
- Review deployment logs in Render

### SMS not received
- Verify Twilio webhook URL is correct
- Check Twilio phone number is active
- Review Twilio logs for errors

### Authentication fails
- Ensure Supabase redirect URLs include your service URL
- Verify email is correct format
- Check session hasn't expired

### Database errors
- Confirm sms_sessions table exists in Supabase
- Check RLS policies are correctly set
- Verify service role key has proper permissions

## Support

For issues or questions:
1. Check Render deployment logs
2. Review Supabase Auth logs
3. Check Twilio console for SMS delivery status
4. Open an issue in the repository

## License

MIT